---
import { getCollection } from "astro:content";
import { Marked } from "marked";
// @ts-ignore
import { markedHighlight } from "marked-highlight";
import { codeToHtml } from "shikiji";
import Layout from "../../layouts/Layout.astro";

export async function getStaticPaths() {
  const posts = await getCollection("projects");
  return posts.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

async function getMostRecentCommit(owner: string, repo: string) {
  const apiUrl = `https://api.github.com/repos/${owner}/${repo}/commits/main`;

  const response = await fetch(apiUrl, {
    headers: {
      Accept: "application/vnd.github.v3+json",
    },
  });

  const data = await response.json();
  const { sha, html_url: url } = data;

  return { sha, url };
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const githubUrl = new URL(entry.data.repo);
const readmeUrl = `https://raw.githubusercontent.com${githubUrl.pathname}/main/README.md`;
const [owner, repo] = githubUrl.pathname.split("/").slice(1, 3);
// TODO: this needs to run on the client to be up to date
const mostRecentCommit = await getMostRecentCommit(owner, repo);
const response = await fetch(readmeUrl);
const markdown = await response.text();
const marked = new Marked(
  markedHighlight({
    async: true,
    langPrefix: "language-",
    highlight(input: string, lang: string) {
      const code = codeToHtml(input, {
        lang,
        theme: "dark-plus",
      });
      return code;
    },
  }),
);
const content = marked.parse(markdown);

// TODO: link to repo
// TODO: link to live project
// TODO: load last commit
---

<Layout title={entry.data.name}>
  <header class="space-y-2 py-4">
    <img
      class="shadow/20 rounded-md"
      srcset={`${entry.data.header_image}, ${entry.data.header_image_2x} 2x`}
      src={entry.data.header_image}
      alt={entry.data.name}
    />
    <div class="text-base">
      <a
        href="/"
        class="text-emerald-600 underline hover:text-emerald-700 dark:text-emerald-200 dark:hover:text-emerald-300"
        >Jonathan Foster</a
      ><span class="text-zinc-500 dark:text-zinc-400">
        - Last Commit: <a
          href={mostRecentCommit.url}
          class="underline dark:hover:text-zinc-500"
          >{mostRecentCommit.sha.slice(0, 16)}</a
        ></span
      >
    </div>
  </header>

  <article set:html={content} class="readme" />

  <Content />
</Layout>

<style is:global>
  .readme {
    @apply font-sans text-base text-zinc-800 dark:text-zinc-300;
  }

  .readme a {
    @apply text-emerald-600 underline hover:text-emerald-700 dark:text-emerald-200 dark:hover:text-emerald-300;
  }

  .readme ul {
    @apply mt-2 list-inside list-disc pl-1;
  }

  .readme ul:has(input[type="checkbox"]) {
    @apply list-none;
  }

  .readme ol {
    @apply mt-4 list-inside list-decimal pl-1;
  }

  .readme ul ul {
    @apply mt-0 pl-4;
  }

  .readme h2 {
    @apply mt-6 font-sans text-xl font-bold;
  }

  .readme h3 {
    @apply mt-4 font-sans text-lg font-bold dark:text-zinc-200;
  }

  .readme p {
    @apply mt-4;
  }

  .readme pre.shiki {
    @apply mt-2 rounded border border-black/10 p-4 font-mono text-sm shadow-sm dark:border-white/5;
  }

  .readme p > code,
  .readme ol code,
  .readme ul code {
    @apply rounded border-0 border-emerald-400 bg-zinc-200/60 px-1 py-px font-mono text-sm text-emerald-700 dark:border-white/10 dark:bg-black/20 dark:text-emerald-300;
  }

  .readme pre code {
    @apply border-0 bg-transparent p-0 font-mono;
  }

  .readme input {
    @apply accent-emerald-500;
  }
</style>
